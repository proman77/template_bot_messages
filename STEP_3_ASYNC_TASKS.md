–í–æ—Ç **–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è** –¥–ª—è –≠—Ç–∞–ø–∞ 3.

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á. –≠—Ç–æ –ø–æ–≤–æ—Ä–æ—Ç–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ, –∫–æ–≥–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –∏–∑ –º–æ–Ω–æ–ª–∏—Ç–∞ –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Å–∏—Å—Ç–µ–º—É.

***

# STEP_3_ASYNC_TASKS.md: –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –û—á–µ—Ä–µ–¥—å –∏ –í–æ—Ä–∫–µ—Ä—ã

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ –º—ã –≤–Ω–µ–¥—Ä—è–µ–º `Taskiq` –∏ —Å–≤—è–∑—ã–≤–∞–µ–º –µ–≥–æ —Å –±—Ä–æ–∫–µ—Ä–æ–º `NATS`. –ú—ã —Ä–∞–∑–¥–µ–ª—è–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –¥–≤–µ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —á–∞—Å—Ç–∏: **Producer** (–ë–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –∑–∞–¥–∞—á–∏) –∏ **Consumer** (–í–æ—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –∏—Ö –≤—ã–ø–æ–ª–Ω—è–µ—Ç).

## üéØ –¶–µ–ª–∏ —ç—Ç–∞–ø–∞
1.  –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –±—Ä–æ–∫–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π (NATS) –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –∑–∞–¥–∞—á.
2.  –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (Redis) –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.
3.  –û—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å **Dependency Injection (DI)**: –æ–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –∏ API Telegram –≤–Ω—É—Ç—Ä–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á.
4.  –°–æ–∑–¥–∞—Ç—å —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –í–æ—Ä–∫–µ—Ä–∞.

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –û—á–µ—Ä–µ–¥–∏ (Infrastructure)

### 1.1. –ë—Ä–æ–∫–µ—Ä (Message Broker)
*   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** NATS (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ `taskiq-nats`).
*   **–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã:** –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **JetStream** (–µ—Å–ª–∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –¥—Ä–∞–π–≤–µ—Ä–∞) –∏–ª–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Core NATS –¥–ª—è –Ω–∞—á–∞–ª–∞. JetStream –∫—Ä–∏—Ç–∏—á–µ–Ω –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞, —á—Ç–æ–±—ã –∑–∞–¥–∞—á–∏ –Ω–µ —Ç–µ—Ä—è–ª–∏—Å—å –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –±—Ä–æ–∫–µ—Ä–∞.
*   **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –¥–æ–ª–∂–µ–Ω –±—Ä–∞—Ç—å—Å—è –∏–∑ `Dynaconf`.

### 1.2. –ë—ç–∫–µ–Ω–¥ –†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (Result Backend)
*   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** Redis (—Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º `taskiq-redis`).
*   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–π (`return value`) –∏ —Å—Ç–∞—Ç—É—Å—ã (Success/Failed).
*   **TTL (Time To Live):** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1 —á–∞—Å), —á—Ç–æ–±—ã Redis –Ω–µ –∑–∞–±–∏–≤–∞–ª—Å—è —É—Å—Ç–∞—Ä–µ–≤—à–∏–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–∫–∞—Ö.

### 1.3. –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏—è
*   **–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è:** `ormsgpack`.
*   **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç –≤–º–µ—Å—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ JSON/Pickle –¥–ª—è —É–ø–∞–∫–æ–≤–∫–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∑–∞–¥–∞—á –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É –ë–æ—Ç–æ–º –∏ –í–æ—Ä–∫–µ—Ä–æ–º.

---

## 2. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Dependency Injection)

–ó–∞–¥–∞—á–∏ Taskiq –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ, –ø–æ—ç—Ç–æ–º—É —É –Ω–∏—Ö –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º –∏–∑ –ø–∞–º—è—Ç–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –ë–æ—Ç–∞. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ —è–≤–Ω–æ "–≤–Ω–µ–¥—Ä–∏—Ç—å" –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.

### 2.1. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö
*   –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º (—á–µ—Ä–µ–∑ Middleware Taskiq –∏–ª–∏ Startup-—Å–æ–±—ã—Ç–∏–µ), –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç **—Ñ–∞–±—Ä–∏–∫—É —Å–µ—Å—Å–∏–π SQLAlchemy** –≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–∫–µ—Ä–∞.
*   –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞, —Ä–∞–±–æ—Ç–∞—é—â–∞—è —Å –ë–î, –¥–æ–ª–∂–Ω–∞ –ø–æ–ª—É—á–∞—Ç—å —Å–≤–µ–∂—É—é —Å–µ—Å—Å–∏—é –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –µ—ë –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

### 2.2. –ö–æ–Ω—Ç–µ–∫—Å—Ç –ë–æ—Ç–∞
*   –í–æ—Ä–∫–µ—Ä—É —á–∞—Å—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, "–û—Ç—á–µ—Ç –≥–æ—Ç–æ–≤").
*   –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä `Bot` –≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ –≤–æ—Ä–∫–µ—Ä–∞ –∏ –ø—Ä–æ–±—Ä–æ—Å–∏—Ç—å –µ–≥–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á.

---

## 3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ó–∞–¥–∞—á (Task Definition)

### 3.1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞
*   –ó–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–µ–∫–æ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–º –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–º –±—Ä–æ–∫–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `@broker.task`).
*   –ê—Ä–≥—É–º–µ–Ω—Ç—ã —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–¥–∞—á –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º—ã–º–∏** (int, string, pydantic models). –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –æ–±—ä–µ–∫—Ç—ã —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, —Ñ–∞–π–ª—ã –∏–ª–∏ —Å–ª–æ–∂–Ω—ã–µ –∫–ª–∞—Å—Å—ã.

### 3.2. –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (Best Practice)
*   –ó–∞–¥–∞—á–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã –∏—Ö –ø–æ–≤—Ç–æ—Ä–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ (–≤ —Å–ª—É—á–∞–µ —Å–±–æ—è —Å–µ—Ç–∏ –∏ —Ä–µ—Ç—Ä–∞—è) –Ω–µ –ª–æ–º–∞–ª–æ –¥–∞–Ω–Ω—ã–µ.

---

## 4. –ó–∞–ø—É—Å–∫ –í–æ—Ä–∫–µ—Ä–∞ (Worker Entrypoint)

–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª/—Å–∫—Ä–∏–ø—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, `app/worker.py`), –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç —Å–ª—É–∂–∏—Ç—å —Ç–æ—á–∫–æ–π –≤—Ö–æ–¥–∞ –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á.

### 4.1. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –í–æ—Ä–∫–µ—Ä–∞
1.  **Startup:**
    *   –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.
    *   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±—Ä–æ–∫–µ—Ä–∞ NATS.
    *   –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î –∏ Redis.
    *   "–ü—Ä–æ–≥—Ä–µ–≤" –∫—ç—à–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ).
2.  **Processing:**
    *   –ü—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏.
    *   –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á.
3.  **Shutdown:**
    *   –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –ë–î, NATS –∏ Redis (Graceful Shutdown), —á—Ç–æ–±—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å –∑–∞–¥–∞—á–∏ –Ω–∞ –ø–æ–ª—É—Å–ª–æ–≤–µ.

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ü—Ä–∏–µ–º–∫–∏ (Definition of Done)

1.  [x] –ù–∞–ø–∏—Å–∞–Ω –∫–æ–¥ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ë—Ä–æ–∫–µ—Ä–∞ (NATS) –∏ –ë—ç–∫–µ–Ω–¥–∞ (Redis).
2.  [x] –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –≤–æ—Ä–∫–µ—Ä–∞ (`app/worker.py`).
3.  [x] –°–æ–∑–¥–∞–Ω–∞ —Ç–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `test_di_task`).
4.  [x] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç:**
    *   –ó–∞–ø—É—â–µ–Ω –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä NATS –∏ Redis.
    *   –ó–∞–ø—É—â–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –í–æ—Ä–∫–µ—Ä–∞.
    *   –ó–∞–ø—É—â–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å –ë–æ—Ç–∞ (–∏–ª–∏ —Å–∫—Ä–∏–ø—Ç-–ø—Ä–æ–¥—å—é—Å–µ—Ä).
    *   –ë–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–¥–∞—á—É -> –í–æ—Ä–∫–µ—Ä –ø–∏—à–µ—Ç –ª–æ–≥ –æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ -> –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–ª—è–µ—Ç—Å—è –≤ Redis.
5.  [x] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: –¢–µ—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –º–æ–∂–µ—Ç —Å–¥–µ–ª–∞—Ç—å `SELECT` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–µ –≤—ã–∑—ã–≤–∞—è –æ—à–∏–±–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.