–í–æ—Ç **–∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è** –¥–ª—è –≠—Ç–∞–ø–∞ 2.

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ª–æ–≥–∏—á–µ—Å–∫–æ–º—É —è–¥—Ä—É –±–æ—Ç–∞, –º–µ—Ö–∞–Ω–∏–∑–º–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ (–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞).

***

# STEP_2_BOT_CORE.md: –Ø–¥—Ä–æ –ë–æ—Ç–∞ –∏ –£—á–µ—Ç –ê—É–¥–∏—Ç–æ—Ä–∏–∏

–ù–∞ —ç—Ç–æ–º —ç—Ç–∞–ø–µ —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è "—Å–µ—Ä–¥—Ü–µ" –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–≥–æ –ü–û (Middleware) –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –ª–æ–≥–∏–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.

## üéØ –¶–µ–ª–∏ —ç—Ç–∞–ø–∞
1.  –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å `Dispatcher` –∏ `Bot` —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ FSM-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞ (NATS).
2.  –ù–∞—Å—Ç—Ä–æ–∏—Ç—å **Dependency Injection (DI)**: –ø—Ä–æ–±—Ä–æ—Å —Å–µ—Å—Å–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏.
3.  –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º **Auto-Registration**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –ø—Ä–∏ –ª—é–±–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.
4.  –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–±—ã—Ç–∏–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –±–æ—Ç–∞ (**Chat Member Events**) –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏ –±–∞–∑—ã —Ä–∞—Å—Å—ã–ª–∫–∏.

---

## 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Core Setup)

### 1.1. –≠–∫–∑–µ–º–ø–ª—è—Ä –ë–æ—Ç–∞
*   –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —Ç–æ–∫–µ–Ω–æ–º, –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –∏–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ (—á–µ—Ä–µ–∑ `Dynaconf`).
*   **–†–µ–∂–∏–º –ø–∞—Ä—Å–∏–Ω–≥–∞:** –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å `HTML` –¥–ª—è –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.

### 1.2. –•—Ä–∞–Ω–∏–ª–∏—â–µ –°–æ—Å—Ç–æ—è–Ω–∏–π (FSM Storage)
*   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **NATS (JetStream)** –≤ –∫–∞—á–µ—Å—Ç–≤–µ –±—ç–∫–µ–Ω–¥–∞ –¥–ª—è FSM (`NatsStorage`).
*   –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–π –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (`MemoryStorage`) **–∑–∞–ø—Ä–µ—â–µ–Ω–æ**, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∏–Ω—Ü–∏–ø stateless-–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —Å –±–æ—Ç–æ–º.
*   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `DefaultKeyBuilder` —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π `with_destiny=True` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –≤ –¥–∏–∞–ª–æ–≥–∞—Ö.

### 1.3. –î–∏—Å–ø–µ—Ç—á–µ—Ä (Dispatcher)
*   –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–æ—É—Ç–µ—Ä—ã (Routers) –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ (–∫–æ–º–∞–Ω–¥—ã, –¥–∏–∞–ª–æ–≥–∏, —Å–æ–±—ã—Ç–∏—è –∞–¥–º–∏–Ω–∫–∏).
*   –û–±–µ—Å–ø–µ—á–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (NATS, Redis, DB) –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –±–æ—Ç–∞ (`shutdown` events).

---

## 2. –°–ª–æ–π Middleware (–ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û)

Middleware ‚Äî —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∞–ø–¥–µ–π—Ç—ã *–¥–æ* —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω–∏ –ø–æ–ø–∞–¥—É—Ç –≤ —Ö–µ–Ω–¥–ª–µ—Ä—ã.

### 2.1. Middleware –ë–î (Database Session DI)
*   **–¢–∏–ø:** Outer Middleware (–≤–Ω–µ—à–Ω—è—è –º–∏–¥–ª–≤–∞—Ä—å).
*   **–ó–∞–¥–∞—á–∞:** –°–æ–∑–¥–∞–≤–∞—Ç—å –Ω–æ–≤—É—é –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é —Å–µ—Å—Å–∏—é SQLAlchemy –¥–ª—è **–∫–∞–∂–¥–æ–≥–æ** –≤—Ö–æ–¥—è—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (Update) –∏ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –µ—ë –≤ –∞—Ä–≥—É–º–µ–Ω—Ç—ã —Ö–µ–Ω–¥–ª–µ—Ä–∞.
*   **–ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª:**
    1.  –ü–æ–ª—É—á–∏—Ç—å –∞–ø–¥–µ–π—Ç.
    2.  –û—Ç–∫—Ä—ã—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é/—Å–µ—Å—Å–∏—é.
    3.  –ü–µ—Ä–µ–¥–∞—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–ª—å—à–µ (–≤ —Ö–µ–Ω–¥–ª–µ—Ä).
    4.  –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ö–µ–Ω–¥–ª–µ—Ä–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã—Ç—å —Å–µ—Å—Å–∏—é (commit –∏–ª–∏ rollback –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏).

### 2.2. Middleware –¢—Ä–µ–∫–∏–Ω–≥–∞ (User Tracking)
*   **–¶–µ–ª—å:** –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ –ª—é–±–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—â–∏–π —Å –±–æ—Ç–æ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î.
*   **–¢—Ä–∏–≥–≥–µ—Ä—ã:** –°–æ–æ–±—â–µ–Ω–∏—è (`Message`) –∏ –ù–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ (`CallbackQuery`).
*   **–õ–æ–≥–∏–∫–∞ (Upsert - Update or Insert):**
    1.  –ò–∑–≤–ª–µ—á—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`id`, `username`, `fullname`, `language`) –∏–∑ –æ–±—ä–µ–∫—Ç–∞ Telegram.
    2.  –í—ã–ø–æ–ª–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –ë–î (`INSERT ... ON CONFLICT DO UPDATE`):
        *   –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å.
        *   –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è `updated_at`, `username`, `fullname` (–Ω–∞ —Å–ª—É—á–∞–π —Å–º–µ–Ω—ã –Ω–∏–∫–Ω–µ–π–º–∞) –∏ –≤—ã—Å—Ç–∞–≤–∏—Ç—å `is_active = True`.
    3.  –≠—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –±—ã—Å—Ç—Ä–æ–π, —á—Ç–æ–±—ã –Ω–µ –∑–∞–º–µ–¥–ª—è—Ç—å –æ—Ç–≤–µ—Ç –±–æ—Ç–∞.

---

## 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –°—Ç–∞—Ç—É—Å–æ–≤ (Chat Member Updates)

–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å –¥–ª—è —Å–∏—Å—Ç–µ–º—ã —Ä–∞—Å—Å—ã–ª–æ–∫. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å, –∫—Ç–æ –µ–≥–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª, —á—Ç–æ–±—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è "–≤ –ø—É—Å—Ç–æ—Ç—É".

### 3.1. –°–æ–±—ã—Ç–∏–µ `my_chat_member`
*   –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞ —á–∞—Ç–∞ (—Å–∞–º–æ–≥–æ –±–æ—Ç–∞).
*   **–°—Ü–µ–Ω–∞—Ä–∏–π "–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞":**
    *   Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ `kicked` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞).
    *   **–î–µ–π—Å—Ç–≤–∏–µ:** –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ `is_active = False`. –£–¥–∞–ª—è—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –ë–î **–Ω–µ–ª—å–∑—è** (–Ω—É–∂–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è).
*   **–°—Ü–µ–Ω–∞—Ä–∏–π "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞":**
    *   Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ, —á—Ç–æ —Å—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ `member` (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ / –Ω–∞–∂–∞–ª "Start").
    *   **–î–µ–π—Å—Ç–≤–∏–µ:** –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–ª–∞–≥ `is_active = True`.

---

## 4. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –û–±—Ä–∞–±–æ—Ç–∫–∞ –û—à–∏–±–æ–∫

*   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `structlog` –∏–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π `logging`).
*   –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –¥–æ–ª–∂–µ–Ω –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º `user_id`, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –æ—Ç—Å–ª–µ–¥–∏—Ç—å –ø—É—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –ª–æ–≥–∞–º.
*   –û—à–∏–±–∫–∏ –ë–î –Ω–µ –¥–æ–ª–∂–Ω—ã "—Ä–æ–Ω—è—Ç—å" –±–æ—Ç–∞. –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –∏, –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏, –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ "–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫", –ª–æ–≥–∏—Ä—É—è —Ç—Ä–µ–π—Å–±—ç–∫.

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ü—Ä–∏–µ–º–∫–∏ (Definition of Done)

1.  [x] –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (Long Polling) –∏ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ NATS.
2.  [x] –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–∞–Ω–¥—ã `/start` –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
    *   –ë–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç.
    *   –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `users`.
3.  [x] –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
    *   –í –ë–î –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø–æ–ª–µ `updated_at`.
    *   –î—É–±–ª–∏–∫–∞—Ç—ã –∑–∞–ø–∏—Å–µ–π –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è.
4.  [x] –ü—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –±–æ—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º:
    *   –í –∫–æ–Ω—Å–æ–ª–∏/–ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ —Å–æ–±—ã—Ç–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏.
    *   –í –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ–ª–µ `is_active` –º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ `False`.
5.  [x] –•–µ–Ω–¥–ª–µ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç –æ–±—ä–µ–∫—Ç —Å–µ—Å—Å–∏–∏ –ë–î (`AsyncSession`) –∫–∞–∫ –∞—Ä–≥—É–º–µ–Ω—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.